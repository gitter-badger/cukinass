
# Основная идея

Научить cucumber выполнять код шагов написанный на 1С в целевой информационной
базе используя протокол wire

## Как задумана реализация

### Wire сервер

Сервер состоит из двух частей. Первая часть написана на Ruby `ruby_side_cuke` вторая часть
написана на 1С `ass_side_cuke`. Ruby слушает tcp порт, принимает и отправляет cucmber-у данные
по протоколу wire. `ass_side_cuke` выполняется в целевой информационной базе.
Части общаются между собой через файлы используя собственный протокол.
Рабочая реализация `ass_side_cuke` находится в форме `main` обработки
`ass_side_cuke.epf`. Интерфейс
протокола определен в `RubyToAssInterface()`. В данной реализации предусмотрен
только односторонний вызов `ruby_side_cuke` вызывает `ass_side_cuke`. Это делает
невозможным корректно вызывать шаги из других шагов.

### Шаги

Пример реализации шагов находится в `TurnSteps()` модуля формы `steps`
`build/features/steps/one_steps.epf`. Кроме шагов `one_steps.epf` содержит
служебный код реализующий DSL cucmber, и методы для доступа к контексту сценария
и т.д. Все методы
являются публичными, кроме разумеется метода `TurnSteps()` и доступны для кода шагов.

По задумке реализации шагов должны храниться в чистом виде в стандартном для
шагов каталоге в файлах с расширением `asd`, сборка обработок для
запуска шагов должна выполнятся на перед запуском сервера при настройке рабочего
окружения

#### Что пока не ясно

Пока весь код шагов на языке 1С выполняется только в контексте клиента и только
в режиме управляемого приложения. Как из шагов вызывать сервер пока неясно.
Скорее всего для этого потребуется придумать механизм вызова сервера для
выполнения произвольного кода используя метод платформы `execute` и возврата
результата вызова как на прямую так и через параметры.

### Фичи

Фичи остаются без особенностей

### Как это должно работать

* Собирается рабочее окружение
* Собираются шаги
* Стартует сервер `cukinass`
* Запускается `cucmber`

## Демо

### Для запуска демонстрации требуется

* gem [ones-devtool](https://github.com/leoniv/ones-devtool) с его зависимостями.
* пакет `cygwin` - `iconv`
* 1С платформа не ниже 8.3.6

### Запускаем

* Открываем две консоли `cygwin`
* В первой косоли `$ sh scripts/start_ass_side_cuke.sh` в консоль будeт
выводится log `ass_side_cuke`
* Во второй консоли шлем команды `ass_side_cuke`. Результат выполнения будет
выводиться в консоль

  * Пингуем `ass_side_cuke` убеждаемся, что жив
  ```
  $ sh scripts/ping.sh
  ```
  * Инициализируем `ass_side_cuke`

  ```
  $ sh scripts/initialize.sh
  ```
  * Стартуем сценарий

  ```
  $ sh scripts/begin_scenario.sh
  ```

  * Запускаем шаги

  ```
  $ sh scripts/step_0.sh
  ...
  $ sh scripts/step_3.sh
  $ sh scripts/step_undefined_id.sh
  ```
  * Для поиграться посылаем не извесный респонс

  ```
  $ echo "['blah',{}]" > ./toass.pipe && sleep 1 && cat fromass.pipe && rm ./fromass.pipe
  ```
  * Для поиграться посылаем мусор

  ```
  $ echo boooom > ./toass.pipe && sleep 1 && cat fromass.pipe && rm ./fromass.pipe
  ```

  * Останавливаем `ass_side_cuke`

  ```
  $ sh scripts/shutdoun.sh
  ```

## Пока все!
